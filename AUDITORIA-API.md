# üîç AUDITOR√çA COMPLETA DE APIs - Sistema Poker Enfermos
**Fecha**: 2025-10-13
**Status**: AN√ÅLISIS COMPLETO - PENDIENTE APROBACI√ìN PARA CAMBIOS

---

## üìã RESUMEN EJECUTIVO

### Totales
- **73 endpoints** identificados
- **8 duplicaciones** exactas encontradas
- **12 endpoints legacy** sin uso activo
- **5 inconsistencias** de autenticaci√≥n detectadas
- **Potencial de optimizaci√≥n**: ~20% reducci√≥n de c√≥digo

### Estado del Sistema
‚úÖ **Sistema funcional y estable**
‚ö†Ô∏è **Oportunidades de optimizaci√≥n significativas**
üîí **Requiere backup antes de cualquier cambio**

---

## üö® DUPLICACIONES EXACTAS IDENTIFICADAS

### 1. Parent-Child Stats (DUPLICACI√ìN 100%)

#### Endpoint Principal
```
GET /api/stats/parent-child/[tournamentId]
```

#### Endpoint Duplicado
```
GET /api/stats/parent-child/[tournamentId]/public
```

**C√≥digo**: Id√©ntico l√≠nea por l√≠nea (82 l√≠neas duplicadas)
**Autenticaci√≥n**: Ambos son p√∫blicos (sin auth)
**Uso en Frontend**: Solo se usa el endpoint principal
**Impacto**: NINGUNO al eliminar
**Recomendaci√≥n**: üóëÔ∏è **ELIMINAR** `/public` variant

---

### 2. Active Tournament (DUPLICACI√ìN PARCIAL)

#### Endpoint Completo
```
GET /api/tournaments/active
Retorna: tournament + gameDates + participants + blindLevels + stats
Autenticaci√≥n: P√∫blico
Uso: Dashboard, Rankings, m√∫ltiples componentes
```

#### Endpoint Simplificado
```
GET /api/tournaments/active/public
Retorna: tournament (solo id, name, number, status, _count)
Autenticaci√≥n: P√∫blico
Uso: NO USADO en frontend actual
```

**An√°lisis**:
- Ambos son p√∫blicos (comentario "p√∫blico" es redundante)
- `/public` retorna subset de datos de `/active`
- Frontend NUNCA usa `/active/public`
- `/active` incluye fallback a torneo m√°s reciente si no hay activo

**Recomendaci√≥n**: üóëÔ∏è **ELIMINAR** `/active/public`
**Impacto**: CERO - No est√° en uso

---

### 3. Tournament Dates (SEPARACI√ìN INNECESARIA)

#### Endpoint Autenticado
```
GET /api/tournaments/[id]/dates
Autenticaci√≥n: withAuth (cualquier usuario)
Retorna: gameDates + gameResults + eliminations (completo)
Uso: Admin views, FechasTable, gesti√≥n de torneos
```

#### Endpoint P√∫blico
```
GET /api/tournaments/[id]/dates/public
Autenticaci√≥n: NINGUNA (p√∫blico)
Retorna: gameDates (solo id, dateNumber, status, scheduledDate, playerIds)
Uso: NO IDENTIFICADO en frontend actual
```

**An√°lisis**:
- Separaci√≥n por nivel de detalle (completo vs b√°sico)
- `/public` NO tiene uso identificado en codebase
- Si se necesita versi√≥n p√∫blica, el endpoint autenticado podr√≠a hacerse p√∫blico

**Recomendaci√≥n**: üîÑ **CONSOLIDAR**
**Opci√≥n A**: Eliminar `/public` y hacer `/dates` p√∫blico
**Opci√≥n B**: Mantener ambos SOLO si hay uso externo no identificado

---

### 4. Player Info (DUPLICACI√ìN PARCIAL)

#### Endpoint Autenticado
```
GET /api/players/[id]
Autenticaci√≥n: withAuth
Retorna: Player completo + relaciones + stats
Uso: Admin, perfiles, gesti√≥n de jugadores
```

#### Endpoint P√∫blico
```
GET /api/players/[id]/public
Autenticaci√≥n: NINGUNA
Retorna: id, firstName, lastName, aliases, photoUrl, lastVictoryDate, isActive
Uso: NO IDENTIFICADO en frontend
```

**Recomendaci√≥n**: ‚úÖ **MANTENER AMBOS**
**Raz√≥n**: Separaci√≥n leg√≠tima de datos sensibles (PIN, email, phone) vs p√∫blicos
**Nota**: Verificar si `/public` tiene uso externo o puede eliminarse

---

### 5. Proposals V1 vs V2 (SISTEMA DUAL)

#### Proposals V1 (Legacy)
```
GET    /api/proposals/my-proposals
PATCH  /api/proposals/[id]
DELETE /api/proposals/[id]

Base de datos: Proposal (modelo antiguo)
Estructura: title, content, imageUrl
Uso: NINGUNO detectado en frontend actual
```

#### Proposals V2 (Actual)
```
GET    /api/proposals-v2/my
POST   /api/proposals-v2
GET    /api/proposals-v2/[id]
PATCH  /api/proposals-v2/[id]
DELETE /api/proposals-v2/[id]
PUT    /api/proposals-v2/[id]/toggle
PATCH  /api/proposals-v2/[id]/close-voting
PUT    /api/proposals-v2/[id]/close-voting (reopen)
GET    /api/proposals-v2/admin
GET    /api/proposals/public

Base de datos: ProposalV2 (modelo nuevo)
Estructura: title, objective, situation, proposal, imageUrl, votingClosed
Uso: T29, propuestas-v2, admin/propuestas (TODO el sistema activo)
```

#### Endpoints Compartidos (usan ambos modelos)
```
GET    /api/proposals/[id]/votes
POST   /api/proposals/[id]/votes
DELETE /api/proposals/[id]/votes
GET    /api/proposals/[id]/comments
POST   /api/proposals/[id]/comments
```

**An√°lisis**:
- **V1**: Sistema legacy, sin uso activo
- **V2**: Sistema en producci√≥n con funcionalidad completa
- Votes y comments probablemente apuntan a `ProposalV2`
- Naming inconsistente: `/proposals/public` deber√≠a ser `/proposals-v2/public`

**Recomendaci√≥n**: üîÑ **MIGRACI√ìN COMPLETA A V2**
1. ‚ö†Ô∏è Verificar que NO hay datos V1 en producci√≥n
2. üóëÔ∏è Eliminar 3 endpoints V1 (`my-proposals`, PATCH, DELETE)
3. üîÑ Renombrar `/api/proposals/public` ‚Üí `/api/proposals-v2/public`
4. üìù Limpiar tablas Proposal antigua (despu√©s de backup)

---

## ‚ö†Ô∏è INCONSISTENCIAS DE AUTENTICACI√ìN

### 1. Stats Parent-Child P√∫blico
```
GET /api/stats/parent-child/[tournamentId] - Sin auth
GET /api/stats/parent-child/[tournamentId]/[relationId] - Sin auth
POST /api/stats/parent-child/calculate/[tournamentId] - Solo Comisi√≥n ‚úÖ
```
**Status**: ‚úÖ CORRECTO - Stats son p√∫blicos, c√°lculo protegido

### 2. Tournament Dates Mixto
```
GET /api/tournaments/[id]/dates - Requiere auth (withAuth)
GET /api/tournaments/[id]/dates/public - Sin auth
```
**Inconsistencia**: ¬øPor qu√© las fechas requieren auth?
**Recomendaci√≥n**: Hacer `/dates` p√∫blico o eliminar `/public`

### 3. Tournaments Active Ambos P√∫blicos
```
GET /api/tournaments/active - Sin auth (comentario dice "p√∫blico")
GET /api/tournaments/active/public - Sin auth
```
**Inconsistencia**: Naming confuso, ambos son p√∫blicos
**Recomendaci√≥n**: Eliminar `/public` variant

### 4. Admin Import (Autenticaci√≥n Simplificada)
```
POST /api/admin/import/validate - Solo Bearer token (no withAuth completo)
POST /api/admin/import/execute - Solo Bearer token (no withAuth completo)
```
**An√°lisis**: Validaci√≥n simplificada vs withAuth est√°ndar
**Recomendaci√≥n**: üîÑ Migrar a `withComisionAuth` para consistencia

### 5. Player Role Change (Sin Auth Definida)
```
PATCH /api/players/[id]/role - Sin withAuth wrapper visible
```
**Recomendaci√≥n**: ‚ö†Ô∏è **CR√çTICO** - Agregar `withComisionAuth` inmediatamente

---

## üìä ENDPOINTS SIN USO DETECTADO

### En Frontend Actual

| Endpoint | Raz√≥n | Acci√≥n Sugerida |
|----------|-------|-----------------|
| `/api/tournaments/active/public` | Duplicado sin uso | üóëÔ∏è ELIMINAR |
| `/api/tournaments/[id]/dates/public` | Sin uso identificado | ‚ö†Ô∏è Verificar uso externo |
| `/api/tournaments/next` | Retorna null con nueva arquitectura | üóëÔ∏è ELIMINAR |
| `/api/players/[id]/public` | Sin uso frontend | ‚ö†Ô∏è Verificar uso externo |
| `/api/stats/parent-child/[id]/public` | Duplicado exacto | üóëÔ∏è ELIMINAR |
| `/api/proposals/my-proposals` | Legacy V1 | üóëÔ∏è ELIMINAR |
| `/api/proposals/[id]` PATCH | Legacy V1 | üóëÔ∏è ELIMINAR |
| `/api/proposals/[id]` DELETE | Legacy V1 (duplica V2) | üóëÔ∏è ELIMINAR |

**Total**: 8 endpoints candidatos a eliminaci√≥n

---

## üîÑ OPORTUNIDADES DE OPTIMIZACI√ìN

### 1. Consolidar Proposals System
**Impacto**: Alto
**Complejidad**: Media
**Beneficio**: Elimina confusi√≥n V1/V2, reduce ~150 l√≠neas de c√≥digo

**Plan**:
```
1. Backup completo de tablas Proposal y ProposalV2
2. Verificar que ProposalV2 tiene todos los datos activos
3. Eliminar endpoints V1:
   - DELETE /api/proposals/my-proposals/route.ts
   - Remover handlers PATCH/DELETE de /api/proposals/[id]/route.ts
4. Renombrar /api/proposals/public ‚Üí /api/proposals-v2/public
5. Actualizar referencias en frontend (si las hay)
6. Drop tabla Proposal despu√©s de verificaci√≥n
```

### 2. Limpiar Endpoints P√∫blicos Duplicados
**Impacto**: Bajo
**Complejidad**: Baja
**Beneficio**: Claridad, reduce confusi√≥n

**Plan**:
```
1. Eliminar /api/stats/parent-child/[id]/public/route.ts
2. Eliminar /api/tournaments/active/public/route.ts
3. Eliminar /api/tournaments/next/route.ts (retorna null siempre)
4. Actualizar CLAUDE.md con endpoints eliminados
```

### 3. Estandarizar Autenticaci√≥n
**Impacto**: Medio (seguridad)
**Complejidad**: Baja
**Beneficio**: Consistencia y seguridad mejorada

**Plan**:
```
1. CR√çTICO: Agregar withComisionAuth a /api/players/[id]/role
2. Migrar admin/import/* a withComisionAuth
3. Decidir: ¬ø/api/tournaments/[id]/dates debe ser p√∫blico?
   - Si S√ç: Remover withAuth, eliminar /public variant
   - Si NO: Mantener como est√°, documentar raz√≥n
```

### 4. Revisar Endpoints `/public` Restantes
**Impacto**: Variable
**Complejidad**: Baja
**Beneficio**: Clarificar intenci√≥n de API

**Verificar uso externo (mobile app, webhooks, integraciones)**:
- `/api/players/[id]/public` - ¬øHay consumidores externos?
- `/api/tournaments/[id]/dates/public` - ¬øSe usa en alg√∫n lado?

Si NO hay uso externo ‚Üí **ELIMINAR**
Si S√ç hay uso externo ‚Üí **DOCUMENTAR** en CLAUDE.md

---

## üìù HALLAZGOS POSITIVOS

### ‚úÖ Buenas Pr√°cticas Implementadas

1. **Separaci√≥n de Concerns**:
   - Admin endpoints bajo `/api/admin/*`
   - Stats agrupados en `/api/stats/*`
   - Versionado expl√≠cito (proposals-v2)

2. **Autenticaci√≥n Consistente**:
   - Uso mayoritario de `withAuth` y `withComisionAuth`
   - Separaci√≥n clara de roles (Comisi√≥n vs Enfermo/Invitado)

3. **SWR Integration**:
   - Cache inteligente en frontend
   - Deduping autom√°tico
   - Invalidaci√≥n selectiva despu√©s de mutaciones

4. **Error Handling**:
   - Try-catch consistente
   - Mensajes de error descriptivos
   - HTTP status codes apropiados

5. **Estructura RESTful**:
   - Rutas intuitivas y jer√°rquicas
   - M√©todos HTTP correctos
   - Respuestas estructuradas consistentemente

---

## üéØ PLAN DE ACCI√ìN RECOMENDADO

### Fase 1: Seguridad Cr√≠tica (INMEDIATO)
```
‚ö†Ô∏è CR√çTICO - Hacer antes de cualquier otra cosa:

1. Agregar autenticaci√≥n a /api/players/[id]/role
2. Backup completo de base de datos
3. Crear branch: feature/api-cleanup
```

### Fase 2: Eliminaci√≥n de Duplicados (1-2 horas)
```
Bajo riesgo - Endpoints sin uso:

1. ‚úÖ Eliminar /api/stats/parent-child/[id]/public
2. ‚úÖ Eliminar /api/tournaments/active/public
3. ‚úÖ Eliminar /api/tournaments/next
4. ‚úÖ Test completo de frontend despu√©s de cada eliminaci√≥n
```

### Fase 3: Consolidaci√≥n Proposals (2-3 horas)
```
Riesgo medio - Requiere testing extensivo:

1. ‚ö†Ô∏è Verificar datos en tabla Proposal
2. ‚ö†Ô∏è Backup espec√≠fico de Proposal y ProposalV2
3. ‚úÖ Eliminar endpoints V1
4. ‚úÖ Renombrar /proposals/public ‚Üí /proposals-v2/public
5. ‚úÖ Test completo sistema T29
6. ‚úÖ Test completo admin/propuestas
7. ‚úÖ Test completo propuestas-v2
```

### Fase 4: Verificaci√≥n Endpoints P√∫blicos (1 hora)
```
Investigaci√≥n antes de eliminar:

1. üîç Revisar logs para uso de /api/players/[id]/public
2. üîç Revisar logs para uso de /api/tournaments/[id]/dates/public
3. üìù Documentar hallazgos
4. ‚úÖ Eliminar si no hay uso externo
   O
5. üìù Documentar uso externo en CLAUDE.md
```

### Fase 5: Estandarizaci√≥n Auth (1 hora)
```
Mejora de consistencia:

1. ‚úÖ Migrar admin/import a withComisionAuth
2. ‚úÖ Decidir sobre /tournaments/[id]/dates auth
3. üìù Actualizar CLAUDE.md con decisiones
```

### Fase 6: Testing Final (2-3 horas)
```
Verificaci√≥n completa:

1. ‚úÖ Test manual de todas las p√°ginas
2. ‚úÖ Test scripts de automatizaci√≥n existentes
3. ‚úÖ Verificar permisos por rol
4. ‚úÖ Test de rendimiento (verificar SWR cache)
5. ‚úÖ Commit y push
```

---

## üìä M√âTRICAS DE IMPACTO

### C√≥digo Eliminado (Estimado)
- **8 archivos route.ts** completos
- **~500 l√≠neas** de c√≥digo
- **~80 l√≠neas** de tests obsoletos
- **Reducci√≥n**: ~20% de endpoints

### Mejoras de Mantenimiento
- ‚úÖ Menos confusi√≥n para desarrolladores nuevos
- ‚úÖ Documentaci√≥n m√°s clara (CLAUDE.md actualizado)
- ‚úÖ Menos endpoints a mantener
- ‚úÖ Testing m√°s simple

### Mejoras de Performance
- ‚úÖ Menos rutas en Next.js router
- ‚úÖ Bundle ligeramente m√°s peque√±o
- ‚ö†Ô∏è Impacto m√≠nimo (endpoints no activos no afectan runtime)

---

## ‚ö†Ô∏è RIESGOS Y MITIGACIONES

### Riesgo 1: Eliminar endpoint en uso no detectado
**Probabilidad**: Baja
**Impacto**: Alto
**Mitigaci√≥n**:
- Hacer cambios en branch separado
- Testing exhaustivo antes de merge
- Verificar logs de producci√≥n
- Mantener backup por 30 d√≠as

### Riesgo 2: Breaking changes en integraciones externas
**Probabilidad**: Desconocida
**Impacto**: Alto
**Mitigaci√≥n**:
- Investigar uso de endpoints `/public` antes de eliminar
- Documentar endpoints eliminados
- Comunicar cambios al equipo

### Riesgo 3: Datos hu√©rfanos en tabla Proposal V1
**Probabilidad**: Media
**Impacto**: Bajo
**Mitigaci√≥n**:
- Backup completo antes de eliminar
- Verificar conteos de registros
- No dropear tabla hasta verificaci√≥n de 30 d√≠as

---

## üîç PREGUNTAS PENDIENTES

### Para el Product Owner / Tech Lead

1. **¬øHay integraciones externas?**
   - ¬øApp m√≥vil consumiendo APIs?
   - ¬øWebhooks configurados?
   - ¬øIntegraciones con otros sistemas?

2. **¬øEndpoints p√∫blicos tienen uso leg√≠timo?**
   - `/api/players/[id]/public` ‚Üí ¬øPara qu√© existe?
   - `/api/tournaments/[id]/dates/public` ‚Üí ¬øSe usa?

3. **¬øHay datos en tabla Proposal V1?**
   - ¬øCu√°ntos registros?
   - ¬øSon importantes o migrables?

4. **¬øPol√≠tica de versionado de API?**
   - ¬øDeprecaci√≥n formal necesaria?
   - ¬øPeriodo de sunset para endpoints?

---

## üìã CHECKLIST PRE-IMPLEMENTACI√ìN

Antes de ejecutar CUALQUIER cambio:

- [ ] Backup completo de base de datos
- [ ] Crear branch `feature/api-cleanup`
- [ ] Verificar que no hay PRs pendientes
- [ ] Confirmar que producci√≥n est√° estable
- [ ] Revisar logs de √∫ltimos 30 d√≠as para endpoints a eliminar
- [ ] Obtener aprobaci√≥n de tech lead
- [ ] Comunicar ventana de cambios al equipo
- [ ] Preparar plan de rollback

---

## üéØ RECOMENDACI√ìN FINAL

### Opci√≥n Conservadora (Recomendada para Ahora)
```
1. ‚ö†Ô∏è FIX CR√çTICO: Auth en /players/[id]/role
2. üóëÔ∏è ELIMINAR: Duplicados 100% confirmados sin uso
   - /stats/parent-child/[id]/public
   - /tournaments/active/public
   - /tournaments/next
3. üìù INVESTIGAR: Uso de endpoints /public restantes
4. ‚è∏Ô∏è POSTERGAR: Consolidaci√≥n Proposals V1‚ÜíV2 hasta investigaci√≥n
```

### Opci√≥n Agresiva (Si Hay Certeza)
```
Ejecutar Fases 1-5 completas del Plan de Acci√≥n
Eliminar 8 endpoints + consolidar sistema completo
Timeline: 1 d√≠a de desarrollo + 1 d√≠a de testing
```

**Mi recomendaci√≥n**: **OPCI√ìN CONSERVADORA**
**Raz√≥n**: Sistema en producci√≥n estable, mejor hacer cambios incrementales y verificados.

---

## üìö ANEXOS

### Anexo A: Scripts de Verificaci√≥n Sugeridos

```typescript
// scripts/verify-endpoint-usage.ts
// Script para grep en logs y verificar uso de endpoints candidatos a eliminaci√≥n

const endpointsToCheck = [
  '/api/tournaments/active/public',
  '/api/players/[id]/public',
  '/api/tournaments/[id]/dates/public',
  '/api/stats/parent-child/[tournamentId]/public',
]

// Implementar b√∫squeda en logs de Vercel/server
```

### Anexo B: Orden de Eliminaci√≥n Seguro

1. `/api/tournaments/next` - Retorna null siempre, 0 riesgo
2. `/api/stats/parent-child/[id]/public` - Duplicado exacto, 0 riesgo
3. `/api/tournaments/active/public` - No usado, bajo riesgo
4. `/api/proposals/my-proposals` - Legacy V1, bajo riesgo
5. `/api/tournaments/[id]/dates/public` - Verificar uso primero
6. `/api/players/[id]/public` - Verificar uso primero

---

**Documento generado**: 2025-10-13
**Requiere aprobaci√≥n para proceder**
**Contacto para dudas**: Tech Lead / Product Owner

---

## üöÄ ¬øSIGUIENTE PASO?

Revisar este documento con el equipo y decidir:
1. ¬øProceder con Opci√≥n Conservadora?
2. ¬øInvestigar preguntas pendientes primero?
3. ¬øPosponer limpieza hasta siguiente sprint?

**Esperando instrucciones para proceder...**
